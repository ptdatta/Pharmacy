<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <title>Profile</title>
  </head>
  <body>
    <nav class="bg-green-600 w-full h-14 p-6 flex items-center justify-between">
      <a href="/"><h1 class="text-white text-3xl">&lt My Profile</h1></a>
      <div class="flex flex-row items-center">
        <a href="/cart" class="m-3">
          <i
            class="fa-solid fa-cart-shopping fa-2xl"
            style="color: #ffffff"
          ></i>
        </a>
        <a href="/profile" class="m-3">
          <i class="fa-solid fa-user fa-2xl" style="color: #ffffff"></i>
        </a>
      </div>
    </nav>
    <div class="my-10 mx-20 flex flex-row items-center">
      <img src="./assets/user.png" alt="user" />
      <div class="mx-8">
        <h1 class="text-2xl" id="name"></h1>
        <h1 class="text-xl" id="phone"></h1>
        <h1 class="text-xl" id="address"></h1>
        <button
          class="mt-6 p-2 border-2 border-red-500 rounded-full"
          onclick="handleLogout()"
        >
          <i
            class="fa-solid fa-right-from-bracket fa-xl"
            style="color: #c11a1a"
          ></i>
        </button>
      </div>
    </div>
    <h1 class="text-2xl ml-20">My Orders:</h1>
    <div id="orderContainer"></div>
    <script>
      const fetchOrders = async () => {
        const user = JSON.parse(localStorage.getItem("user"));
        try {
          const response = await fetch(`/api/getOrderbyUser?UId=${user.UId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          console.log(data);
          renderOrders(data);
        } catch (error) {
          console.error("Error fetching products:", error);
        }
      };

      const renderOrders = (orders) => {
        const orderContainer = document.getElementById("orderContainer");
        let disabled = false;

        orders.forEach((order) => {
          if (!order.status) {
            disabled = true;
          }
          const orderDiv = document.createElement("div");
          orderDiv.className =
            "mx-20 my-5 w-80% flex flex-row justify-between items-center p-5 rounded-2xl shadow-xl";

          const productInfoContainer = document.createElement("div");

          const valueObj = JSON.parse(order.Value);

          for (const [productName, quantity] of Object.entries(valueObj)) {
            const productParagraph = document.createElement("p");
            productParagraph.textContent = `${productName}: ${quantity}`;
            productInfoContainer.appendChild(productParagraph);
          }

          const statusContainer = document.createElement("div");
          statusContainer.className = "flex flex-row my-4 items-center";

          for (let i = 0; i < 5; i++) {
            const statusBox = document.createElement("div");
            statusBox.className = `h-6 w-2 ${
              !disabled ? "bg-blue-500" : "bg-gray-500"
            } mr-2`;
            statusContainer.appendChild(statusBox);
          }

          const cancelButton = document.createElement("button");
          cancelButton.className = `px-6 py-2 text-white ${
            !disabled ? "bg-red-400" : "bg-gray-400"
          } rounded-xl`;
          cancelButton.textContent = "Cancel Order";
          cancelButton.disabled = disabled;
          cancelButton.addEventListener("click", () => handleCancel(order));

          statusContainer.appendChild(cancelButton);

          const arrivedAtParagraph = document.createElement("p");
          arrivedAtParagraph.textContent = `Arrived at: ${getNextDayFormatted(
            order.Date
          )}`;

          productInfoContainer.appendChild(statusContainer);
          productInfoContainer.appendChild(arrivedAtParagraph);

          const totalParagraph = document.createElement("div");
          totalParagraph.className = "text-xl";
          totalParagraph.textContent = `Total: ${order.price}/-`;

          orderDiv.appendChild(productInfoContainer);
          orderDiv.appendChild(totalParagraph);

          orderContainer.appendChild(orderDiv);

          if (order.status) {
            statusContainer
              .querySelectorAll(".bg-blue-500")
              .forEach((box, index) => {
                setTimeout(() => {
                  box.style.backgroundColor = "grey";
                }, index * 500);
              });
            setTimeout(() => {
              disabled = true;
              cancelButton.disabled = true;
              cancelButton.className =
                "px-6 py-2 text-white bg-gray-400 rounded-xl";
            }, 2500);
            setTimeout(() => {
              updateStatus(order.OrderId, order.UId);
            }, 9000);
          }
        });
      };

      function handleCancel(order) {
        const { UId, OrderId } = order;

        fetch(`/api/deleteOrderByUser?UId=${UId}&OrderId=${OrderId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Order deleted successfully:", data);
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error deleting order:", error);
          });
      }

      function updateStatus(orderId, userId) {
        const url = `http://localhost:3000/api/updateStatus?OrderId=${orderId}&UId=${userId}`;

        return fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Status updated successfully:", data);
          })
          .catch((error) => {
            console.error("Error updating status:", error);
          });
      }

      function getNextDayFormatted(inputDateString) {
        const inputDate = new Date(inputDateString);
        const nextDay = new Date(inputDate);
        nextDay.setDate(nextDay.getDate() + 1);
        const options = { day: "2-digit", month: "short", year: "numeric" };
        const formattedDate = nextDay.toLocaleDateString("en-US", options);

        return formattedDate;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
          window.location.href = "/login";
        }
        document.getElementById("name").innerHTML = `Name: ${user.name}`;
        document.getElementById("phone").innerHTML = `Phone No: ${user.phone}`;
        document.getElementById(
          "address"
        ).innerHTML = `Address: ${user.address}`;
      });

      function handleLogout() {
        localStorage.removeItem("user");
        window.location.href = "/login";
      }
      fetchOrders();
    </script>
  </body>
</html>
