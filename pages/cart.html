<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <title>Cart</title>
  </head>
  <body>
    <nav class="bg-green-600 w-full h-14 p-6 flex items-center justify-between">
      <a href="/"><h1 class="text-white text-3xl">&lt My Cart</h1></a>
      <div class="flex flex-row items-center">
        <a href="/cart" class="m-3">
          <i
            class="fa-solid fa-cart-shopping fa-2xl"
            style="color: #ffffff"
          ></i>
        </a>
        <a href="/profile" class="m-3">
          <i class="fa-solid fa-user fa-2xl" style="color: #ffffff"></i>
        </a>
      </div>
    </nav>
    <div class="flex flex-col justify-center p-5" id="cartContainer"></div>
    <h1 class="mx-10 my-3 text-3xl" id="total"></h1>
    <button id="order" onclick="handleOrder()"></button>
    <script>
      let total = 0;
      let cartdetails;
      const fetchProducts = async () => {
        const user = JSON.parse(localStorage.getItem("user"));
        try {
          const response = await fetch(`/api/getCartbyUser?UId=${user.UId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          cartdetails = data;
          renderProducts(data);
        } catch (error) {
          console.error("Error fetching products:", error);
        }
      };
      const renderProducts = (products) => {
        const cartContainer = document.getElementById("cartContainer");
        products.forEach((product) => {
          total += product.price;
          const productContainer = document.createElement("div");
          productContainer.className =
            "h-32 w-[1000px] bg-green-200 m-2 rounded-2xl flex flex-row items-center justify-between";

          const productInfoContainer = document.createElement("div");
          productInfoContainer.className = "flex flex-row items-center";

          const productImage = document.createElement("img");
          productImage.className = "h-32 w-48 rounded-tl-2xl rounded-bl-2xl";
          const imageUrl = `data:image/jpeg;base64,${arrayBufferToBase64(
            product.image.data
          )}`;
          productImage.src = imageUrl;
          productImage.alt = "Product";

          const productName = document.createElement("h1");
          productName.className = "mx-5 text-3xl";
          productName.textContent = product.pname;

          productInfoContainer.appendChild(productImage);
          productInfoContainer.appendChild(productName);

          const rightSideContainer = document.createElement("div");
          rightSideContainer.className = "flex flex-row items-center";
          const actionButtonsContainer = document.createElement("div");
          actionButtonsContainer.className =
            "flex flex-row items-center mx-2 bg-green-400 rounded-xl";

          const productPrice = document.createElement("h1");
          productPrice.className = "mx-5 text-3xl";
          productPrice.textContent = `${product.price}/-`;
          const increaseButton = createButton("+", product);
          const quantityDisplay = createQuantityDisplay(product.quantity);
          const decreaseButton = createButton("-", product);
          const deleteButton = createDeleteButton(product);

          rightSideContainer.appendChild(productPrice);
          actionButtonsContainer.appendChild(increaseButton);
          actionButtonsContainer.appendChild(quantityDisplay);
          actionButtonsContainer.appendChild(decreaseButton);
          actionButtonsContainer.appendChild(deleteButton);
          rightSideContainer.appendChild(actionButtonsContainer);

          productContainer.appendChild(productInfoContainer);
          productContainer.appendChild(rightSideContainer);

          cartContainer.appendChild(productContainer);
        });
        const totalPrice = document.getElementById("total");
        totalPrice.innerHTML = `Total:   ${total}/-`;
        const orderButton = document.getElementById("order");
        orderButton.className = "mx-10 my-3 px-6 py-3 bg-green-400 rounded-xl";
        orderButton.textContent = "Order";
      };

      const createButton = (text, product) => {
        const button = document.createElement("button");
        button.className = "text-2xl p-3 hover:bg-green-500 rounded-xl";
        button.textContent = text;
        button.addEventListener("click", () => handleUpdate(text, product));
        return button;
      };

      const handleUpdate = (text, product) => {
        const user = JSON.parse(localStorage.getItem("user"));
        let option;
        if (text === "+") {
          option = "increase";
        } else if (text === "-" && product.quantity === 1) {
          option = "remove";
        } else if (text === "-") {
          option = "decrease";
        }
        const url = `http://localhost:3000/api/updateCart?UId=${user.UId}&productId=${product.producttId}&value=${option}`;
        fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((responseData) => {
            console.log("Cart updated successfully:", responseData);
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error updating cart:", error);
          });
      };

      const createQuantityDisplay = (quantity) => {
        const quantityDisplay = document.createElement("h1");
        quantityDisplay.className = "text-2xl p-3";
        quantityDisplay.textContent = quantity;
        return quantityDisplay;
      };

      const createDeleteButton = (product) => {
        const deleteButton = document.createElement("button");
        deleteButton.className = "p-3 hover:bg-green-500 rounded-xl";
        const trashIcon = document.createElement("i");
        trashIcon.className = "fa-solid fa-trash";
        trashIcon.style.color = "#d10000";
        deleteButton.appendChild(trashIcon);
        deleteButton.addEventListener("click", () => handleDelete(product));
        return deleteButton;
      };

      const handleDelete = (product) => {
        const user = JSON.parse(localStorage.getItem("user"));
        const url = `http://localhost:3000/api/updateCart?UId=${user.UId}&productId=${product.producttId}&value=remove`;
        fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((responseData) => {
            console.log("Cart updated successfully:", responseData);
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error updating cart:", error);
          });
      };

      const handleOrder = () => {
        const user = JSON.parse(localStorage.getItem("user"));
        const orderValue = cartdetails.reduce((result, cart) => {
          result[cart.pname] = cart.quantity;
          return result;
        }, {});
        const orderData = {
          UId: user.UId,
          address: user.address,
          value: orderValue,
          price: total,
        };
        fetch("http://localhost:3000/api/order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(orderData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Order successful:", data);
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error making order:", error);
          });
      };

      const arrayBufferToBase64 = (buffer) => {
        const binary = Array.from(new Uint8Array(buffer))
          .map((byte) => String.fromCharCode(byte))
          .join("");
        return btoa(binary);
      };
      fetchProducts();
    </script>
  </body>
</html>
